stages:
  - clean
  - provision
  - deploy

clean:stage:
  stage: clean
  environment:
    name: staging
  script:
     - vagrant halt
     - vagrant destroy
  allow_failure: true

provision:stage:
  stage: provision
  environment:
    name: staging
  script:
     - vagrant up
     - vagrant provision
  only:
    - master
  tags:
    - vagrant
    
deploy:stage:
  stage: deploy
  environment:
    name: production
  script:
     - docker stack deploy --compose-file=/vagrant/portainer-stack.yml portainer_stack 
  only:
    - master
  tags:
    - manager-swarm
